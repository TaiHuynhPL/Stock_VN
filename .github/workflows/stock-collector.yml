name: Stock Collector - Automated Daily Collection

on:
  # Scheduled runs (UTC time — Vietnam is UTC+7)
  schedule:
    # 17:00 VN (10:00 UTC) Mon-Fri: Update stock listing
    - cron: '0 10 * * 1-5'
    # 17:30 VN (10:30 UTC) Mon-Fri: Collect daily prices
    - cron: '30 10 * * 1-5'
    # 17:45 VN (10:45 UTC) Mon-Fri: Collect market indices
    - cron: '45 10 * * 1-5'
    # 08:00 VN (01:00 UTC) Saturday: Collect financial statements
    - cron: '0 1 * * 6'

  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      collect_type:
        description: 'Type of data to collect'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - listing
          - price
          - index
          - financial

env:
  DOCKER_IMAGE: stock-collector

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine collection type
        id: determine
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "collect_type=${{ github.event.inputs.collect_type }}" >> $GITHUB_OUTPUT
          else
            # Determine type based on cron schedule time
            CRON="${{ github.event.schedule }}"
            case "$CRON" in
              "0 10 * * 1-5")
                echo "collect_type=listing" >> $GITHUB_OUTPUT
                ;;
              "30 10 * * 1-5")
                echo "collect_type=price" >> $GITHUB_OUTPUT
                ;;
              "45 10 * * 1-5")
                echo "collect_type=index" >> $GITHUB_OUTPUT
                ;;
              "0 1 * * 6")
                echo "collect_type=financial" >> $GITHUB_OUTPUT
                ;;
              *)
                echo "collect_type=all" >> $GITHUB_OUTPUT
                ;;
            esac
          fi
          echo "Running collection type: $(cat $GITHUB_OUTPUT)"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (with cache)
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: ${{ env.DOCKER_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run stock collector
        run: |
          docker run --rm \
            -e DB_HOST=${{ secrets.DB_HOST }} \
            -e DB_PORT=${{ secrets.DB_PORT }} \
            -e DB_NAME=${{ secrets.DB_NAME }} \
            -e DB_USER=${{ secrets.DB_USER }} \
            -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
            -e VNSTOCK_API_KEY=${{ secrets.VNSTOCK_API_KEY }} \
            ${{ env.DOCKER_IMAGE }}:latest \
            collect-daily -t ${{ steps.determine.outputs.collect_type }}

      - name: Report status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Collection completed successfully"
          else
            echo "❌ Collection failed"
          fi
